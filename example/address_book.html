<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>reTHINK Project</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link href="css/uploadfile.css" rel="stylesheet">
    <link rel="stylesheet" href="jquery-ui-1.11.4.custom/jquery-ui.min.css">
</head>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="js/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<!-- Latest compiled and minified CSS -->

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<!-- For Upload file -->
<script type="text/javascript" src="js/bootstrap-filestyle.min.js"></script>
<!-- For Pop up window-->
<script src="jquery-ui-1.11.4.custom/external/jquery/jquery.js"></script>
<script src="jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
<script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js"></script>
<script src="./guid.bundle.js"></script>
<script type="text/javascript">
    var obj = []; //Empty JSON Object to store the friendlist temporarily 

    //Call function to be called on click event of call button
    function call(j) {
        alert("Calling " + obj[j].mnum);
    }
    //Message function to be called on click event of message button
    function message(j) {
        alert("Message sent to " + obj[j].mnum)
    }
    //removing a friend
    function deleteRecordByFileName(myArr, fname) {
        var index = null;
        console.log("before length is " + myArr.length)
        for (var i = 0; i < myArr.length; i++) {
            if (myArr[i].fname === fname) {
                index = i;
                break;
            }
        }
        if (index !== null) {
            myArr.splice(index, 1);
        }
        console.log("length is " + myArr.length)
        return myArr;
    }

    //remove friend
    function removeFriend(j) {
        if (confirm('Are you sure you want to delete this friend from your friend list?')) {
            var userdel = obj[j].fname;
            window.runtime.runtime.removeContact(obj[j].guid);
            obj = deleteRecordByFileName(obj, obj[j].fname);
            createFriendList(obj);
            details(0);
            export_list(obj);
            $("#message_lbl").html('<h4 ><span style="font-family:Verdana;font-size:12px;font-weight:bold;color:FFFFFF;" class="label label-success"> *Your friend \"' + userdel + '\" has been successfully removed </span></h4>');
        } else {
            // Do nothing!
        }
    }

    function sortFriends(obj) {
        obj.sort(function(a, b) {

            if (a.fname.toLowerCase() < b.fname.toLowerCase())
                return -1;

            if (a.fname.toLowerCase() > b.fname.toLowerCase())
                return 1;
            return 0;

        });
    }
    //create friendlist
    function createFriendList(obj) {
        sortFriends(obj);
        if (obj.length !== 0) {
            var table = '<table class="table table-hover" id="mytable">';
            var i = 0;
            $.each(obj, function() {
                table += '<tr><td><button type="button" class="btn btn-primary btn-lg btn-block" data-toggle="button" aria-pressed="false" autocomplete="off" id="button' + i + '" onclick=details(' + i + ')><b>' + this['fname'] + '\t' + this['lname'] + '</b></button></td></tr>';
                i++;
            });
            table += '</table>';
            $("#left-div").html(table);
        } else {
            $("#left-div").html("<br><br><br><h3 align='center' style='color:red;'><b>\"No contacts in the imported file, Please upload another file\"</b></h4> ");
        }
    }

    //Function to write details on click of a friend's name
    function details(j) {
        if (obj.length !== 0) {
            console.log("helloValue from obj " + obj[j].fname);
            $("#right-div").html(
                "<table class='table table-hover'><tr><td><b>First Name</b></td><td>" + obj[j].fname + "</td><td><button class='btn btn-info' onclick=edit_values(1," + j + ")>Edit</button></td>" +
                "<tr><td><b>Last Name </b></td><td>" + obj[j].lname + "</td><td><button class='btn btn-info' onclick=edit_values(2," + j + ")>Edit</button></td></tr>" +
                "<tr><td><b>GUID </b></td><td>" + obj[j].GUID + "</td><td><button class='btn btn-info' onclick=edit_values(3," + j + ")>Edit</button></td></tr>" +
                "<tr><td colspan=3 align='middle'><button class='btn btn-success' onclick=call(" + j + ")><span class='glyphicon glyphicon-earphone'> <b>Call</b></span></button></td></tr>" +
                "<tr><td colspan=3 align='middle'><button class='btn btn-warning' onclick=call(" + j + ")><span class='glyphicon glyphicon-envelope'> <b>Text</b></span></button></td></tr>" +
                "<tr><td colspan=3 align='middle'><button class='btn btn-danger' onclick = removeFriend(" + j + ")><span class='glyphicon glyphicon-trash'><b> Remove</b></span></button></td></tr>" +
                "</table>");
        } else {
            $("#right-div").html("<br><br><br><h3 align='center' style='color:red;'><b>\"All the contacts have been deleted\"</b></h4> ");
            $("#message_lbl").html('<h4 ><span style="font-family:Verdana;font-size:12px;font-weight:bold;color:FFFFFF;" class="label label-danger"> *All the contacts have been deleted</span></h4>');
        }
    }

    //Adding a new user
    function export_list(obj) {
        var data = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obj));
        var a = document.createElement('a');
        a.href = 'data:' + data;
        a.download = 'contacts.json';
        a.innerHTML = '<span class="glyphicon glyphicon-download-alt"><b><u>Download your Contacts</b></u><span>';
        a.class = 'btn btn-primary';
        $("#export_link").html(a);
    }

    function useGUID() {

        var seed = $("#seed").val();
        if (seed == "" || seed == null) {
            alert("please enter seed");
        } else {
            console.log("seed is" + seed);
            window.runtime.runtime.useGUID(seed);
        }

    }

    //edit friend's detail
    function edit_values(l, j) {
        $('tr:nth-child(' + l + ') td:nth-child(2)').each(function() {
            console.log("Editing the value ");
            var html = $(this).html();
            if (l == 1) {
                var input = $('<input id="efname" type="text" />');
            } else if (l == 2) {
                var input = $('<input id="elname" type="text" />');
            } else {
                var input = $('<input id="eguid" type="text" />');
            }
            input.val(html);
            $(this).html(input);
            $('tr:nth-child(' + l + ') td:nth-child(3)').html("<button class='btn btn-info' onclick=edit_friend(" + l + "," + j + ")>Done</button>");
        });
    }

    //validations
    function checkLength(o, n, min, max) {
        if (o.val().length > max || o.val().length < min) {
            return false;
        } else {
            return true;
        }
    }

    function checkRegexp(o, regexp, n) {
        if (!(regexp.test(o.val()))) {
            return false;
        } else {
            return true;
        }
    }
    //commiting the changes
    function edit_friend(l, j) {
        var error_status = false;
        if (l == 1 && checkLength($("#efname"), "firstname", 1, 20) && checkRegexp($("#efname"), /^[a-zA-Z]*$/, "firstname can consist of a-z only")) {
            obj[j].fname = $("#efname").val();
            error_status = true;
        }
        if (l == 2 && checkLength($("#elname"), "Lastname", 1, 20) && checkRegexp($("#elname"), /^[a-zA-Z]*$/, "Lastname can consist of a-z only")) {
            obj[j].lname = $("#elname").val();
            error_status = true;
        }
        if (l == 3 && checkRegexp($("#eguid"), /^[a-z0-9]+$/i, "GUID can consist of only alphanumeric characters") && checkLength($("#eguid"), "guid", 8, 32)) {
            obj[j].GUID = $("#eguid").val();
            error_status = true;
        }
        if (error_status) {
            details(j);
            createFriendList(obj);
            export_list(obj);
            $("#message_lbl").html('<h4 ><span style="font-family:Verdana;font-size:12px;font-weight:bold;color:FFFFFF;" class="label label-success"> *Details have been updated successfully</span></h4>');
        } else {
            alert("Please enter valid details");
        }
    }

    function search_friend() {
        var name = $("#searchBox").val();
        window.runtime.runtime.getContact(name.toLowerCase());
        window.addEventListener("message", getContact, false);
    }


    function getContact(event) {
        var name = $("#searchBox").val();
        if (event.data.to == "runtime:getContact") {
            var tempObj = [];
            var userFirstName = event.data.body.firstName;
            var userLastName = event.data.body.lastName;
            var userExist = event.data.body.userExist;
            if (name == "") {
                createFriendList(obj);
            } else {
                for (var i = 0; i < obj.length; i++) {
                    if ((obj[i].fname.toLowerCase() == name.toLowerCase() || obj[i].lname.toLowerCase() == name.toLowerCase()) && (userFirstName.toLowerCase() == name.toLowerCase() || userLastName.toLowerCase() == name.toLowerCase()) && userExist) {
                        console.log("found a contact" + userFirstName);
                        $("#message_lbl").html('<span style="font-family:Verdana;font-size:12px;font-weight:bold;color:FFFFFF;" class="label label-success"> *Found a contact with name \"' + name + '\"</span>');
                        tempObj.push(obj[i]);
                    }
                };
                if (tempObj.length == 0) {
                    $('#left-div').html("<h3 align='center'> <b>No such contact with name </b> \"" + name + "\"</h3>");
                    $("#message_lbl").html('<span style="font-family:Verdana;font-size:12px;font-weight:bold;color:FFFFFF;" class="label label-success"> *No Such contact with name \"' + name + '\"</span>');
                } else {
                    createFriendList(tempObj);
                }
            }
        }
    }

    function add_user_id() {
        var userid = prompt("Please enter user ID you would like to add ", "");
        if (userid != "" && userid != null) {
            window.runtime.runtime.addUserID("userid");
            $("#message_lbl").html('<span style="font-family:Verdana;font-size:12px;font-weight:bold;color:FFFFFF;" class="label label-success"> *User ID \"' + userid+ '\" is successfully Added</span>');
            //alert("User Id "+userid+" is added succussfully");
        } else {
            alert("user ID cannot be blank");
        }
    }

    function remove_user_id() {
        var userid = prompt("Please enter user ID you would like to remove ", "");
        if (userid != "" && userid != null) {
            window.runtime.runtime.removeUserID(userid);
            $("#message_lbl").html('<span style="font-family:Verdana;font-size:12px;font-weight:bold;color:FFFFFF;" class="label label-danger"> *User ID \"' + userid+ '\" is successfully deleted</span>');
            //alert("User Id "+userid+" is deleted succussfully");
        } else {
            alert("user ID cannot be blank");
        }
    }

    function query_global_registry() {
        window.runtime.runtime.queryGlobalRegistry('shdfjdskfjs7fdsd87few87fs898sa');
    }

    function generate_guid() {
        var guid = window.runtime.runtime.generateGUID();
        $("#message_lbl").html('<span style="font-family:Verdana;font-size:12px;font-weight:bold;color:FFFFFF;" class="label label-success"> *GUID is \"' + guid + '\"</span>');
    }
    //Generating list of friends dynamically
    $(document).ready(function() {
     
        $('#login').html('<div class="container">' +
            '<!-- Trigger the modal with a button -->' +
            '' +
            '<!-- Modal -->' +
            '<div class="modal fade" id="myLogin" role="dialog">' +
            '<div class="modal-dialog">' +
            '<!-- Modal content-->' +
            '<div class="modal-content" align="left">' +
            '<div class="modal-header">' +
            '<button type="button" class="close" data-dismiss="modal">&times;</button>' +
            '<h4 class="modal-title"><b>Login using Seed</b></h4>' +
            '</div>' +
            '<div class="modal-body">' +
            '<label align="left">Please enter the 12 word seed</label>' +
            '<input name="seed" type="text" id="seed" style=" width: 500px;" placeholder="Enter seed..."/>' +
            '</div>' +
            '<div class="modal-footer">' +
            '<button type="button" class="btn btn-default" onclick=useGUID() data-dismiss="modal" >login</button><button type="button" class="btn btn-default" data-dismiss="modal">Close</button>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>');
    });
    //funtion for dialogue box to add new friend with validation
    $(function() {
        var dialog, form;
        var fname = $("#fname");
        var lname = $("#lname");
        var mnum = $("#mnum");
        var age = $("#age");
        var guid = $("#guid");
        allFields = $([]).add(fname).add(lname).add(age).add(guid).add(mnum),
            tips = $(".validateTips");

        function updateTips(t) {
            tips
                .text(t)
                .addClass("ui-state-highlight");
            setTimeout(function() {
                tips.removeClass("ui-state-highlight", 1500);
            }, 500);
        }

        function checkLength(o, n, min, max) {
            if (o.val().length > max || o.val().length < min) {
                o.addClass("ui-state-error");
                updateTips("Length of " + n + " must be between " +
                    min + " and " + max + ".");
                return false;
            } else {
                return true;
            }
        }

        function checkRegexp(o, regexp, n) {
            if (!(regexp.test(o.val()))) {
                o.addClass("ui-state-error");
                updateTips(n);
                return false;
            } else {
                return true;
            }
        }

        function addUser() {
            var valid = true;
            allFields.removeClass("ui-state-error");
            valid = valid && checkLength(fname, "firstname", 1, 20);
            valid = valid && checkLength(lname, "lastlname", 1, 20);
            valid = valid && checkLength(guid, "guid", 8, 32);
            valid = valid && checkLength(age, "age", 1, 2);
            valid = valid && checkRegexp(fname, /^[a-zA-Z]*$/, "firstname can consist of a-z only");
            valid = valid && checkRegexp(lname, /^[a-zA-Z]*$/, "lastname can consist of a-z only");
            valid = valid && checkRegexp(guid, /^[a-z0-9]+$/i, "GUID can consist of only alphanumeric characters");
            valid = valid && checkRegexp(age, /^\d+$/, "age can only be a two digit number");
            //valid = valid && checkRegexp( mnum, /^[0-9]\d{10}$/, "Mobile Number can only be 10 digits long" );
            if (valid) {
                obj.push({
                    "fname": fname.val(),
                    "lname": lname.val(),
                    "age": age.val(),
                    "GUID": guid.val(),
                    "mnum": mnum.val()
                });
                window.runtime.runtime.addContact(guid.val(), fname.val().toLowerCase(), lname.val().toLowerCase());
                $("#message_lbl").html('<span style="font-family:Verdana;font-size:12px;font-weight:bold;color:FFFFFF;" class="label label-success"> *User ' + fname.val()+ ' is added</span>');
                dialog.dialog("close");
                createFriendList(obj);
                export_list(obj);
            }
            return valid;
        };

        dialog = $("#dialog-form").dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "Create an account": addUser,
                Cancel: function() {
                    dialog.dialog("close");
                }
            },
            close: function() {
                form[0].reset();
                allFields.removeClass("ui-state-error");
            }
        });

        form = dialog.find("form").on("submit", function(event) {
            event.preventDefault();
            addUser();

        });

        $("#add_new_btn").button().on("click", function() {
            dialog.dialog("open");
        });
    });

    //Uploading JSON
    $(document).on('change', '.filestyle', function(event) {
        var reader = new FileReader();

        reader.onload = function(event) {
            obj = JSON.parse(event.target.result);
            //alert(Obj[0].fname);
            console.log("uploaded file");
            createFriendList(obj);
            export_list(obj);
            if(obj.length!=0){
                details(0);
            } else {
                $("#right-div").html("<br><br><br><h3 align='center' style='color:red;'><b>\"No contacts in the imported file\"</b></h4> ");
            }
            

        }
        reader.readAsText(event.target.files[0]);
    });
</script>

<body>
    <!-- Pop up Input Form -->
    <div id="dialog-form" title="Create new user">
        <p class="validateTips">All form fields are required.</p>
        <form id="dform" class="addform">
            <fieldset>
                <label>First Name</label>
                <input name="fname" type="text" id="fname" class="text ui-widget-content ui-corner-all" />
                <label>Last Name</label>
                <input name="lname" type="text" id="lname" class="text ui-widget-content ui-corner-all" /><br>
                <label>Age</label>
                <input name="age" type="text" id="age" class="text ui-widget-content ui-corner-all" /><br>
                <label for="mnum">Mobile Number</label>
                <input name="mnum" type="text" id="mnum" class="text ui-widget-content ui-corner-all" /><br>
                <label for="guid">GUID</label>
                <input name="guid" type="text" id="guid" class="text ui-widget-content ui-corner-all" />
                <!-- Allow form submission with keyboard without duplicating the dialog button -->
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>
    <!--CONTAINER-->
    <div id="container">
        <!--HEADER-->
        <div id="header">
            <div id="logo"><img src="images/logo.jpg" alt="reTHINK logo" height="50" width="300"></div>

            
        </div>
        <!--CONTENT AREA-->
        <div id='body'>
            <div id="div1">
                <div id="content_area" class="col-sm-12">
                    <p style="text-align:center;">
                        <span style="font-family:Verdana;font-size:24px;font-style:normal;font-weight:bold;text-decoration:none;text-transform:none;color:FFFFFF; ">AddressBook</span>
                    </p>
                </div>
            </div>

            <!-- All the links and search button-->
            <div class="row" id="exp_imp" style="border-bottom: 2px solid maroon;">
                <!-- Row1: Upload button -->
                <div id="import_div" class="col-sm-2">
                    <input type="file" class="filestyle" data-input="false" text="Import">
                </div>
                <!-- Row4: Generate split button-->
                <div id="search_div" class="col-sm-2" style="padding-top: 2px">
                    <div class="btn-group">
                        <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Please select the option from the dropdown">
                        Generate/Query <span class="caret"></span>
                        <span class="sr-only"></span>
                        </button>
                        <ul class="dropdown-menu" border: 1px solid black;>
                            <li><a class="btn btn-default" onclick="query_global_registry()"><b><span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>Query Global Registry</b></a></li>
                            <li><a class="btn btn-default" onclick="generate_guid()"><b><span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>Generate your GUID</b></a></li>
                        </ul>
                    </div>
                </div>
                <!-- Row5: Account split button-->
                <div id="add_new_div" class="col-sm-2" style="padding-bottom: 2px">
                   <div class="dropdown">
                        <button type="button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Please select the option from the dropdown">
                        Your Account <span class="caret"></span>
                        <span class="sr-only"></span> 
                        </button>
                        <ul class="dropdown-menu" style="border: 1px solid black;">
                            <li><a class="btn btn-default" id="add_user_id" onclick="add_user_id()"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add User ID</a></li>
                            <li><a class="btn btn-default" id="remove_user_id" onclick="remove_user_id()"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span>Remove User ID</a></li>
                            <li><a class="btn btn-default" id="add_new_btn"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span><span class="glyphicon glyphicon-user" aria-hidden="true"></span> Add a Friend</a></li>
                            <li><a class="btn btn-default" data-toggle="modal" data-target="#myLogin"><span class="glyphicon glyphicon-log-in"> Login</span></a></li>
                        </ul>
                    </div>
               </div>
               <!--Row3: Message strip to display -->
                <div id="message_lbl" class="col-sm-3" style="padding-top: 2px;" align="left"> </div>
                <!--Row2: search button and Box -->
                <div class="col-sm-3" align="right">
                    <div class="input-group" style="padding-top: 2px;">
                        <input type="text" class="form-control" style="height:30px;" placeholder="Search a friend..." id="searchBox">
                        <span class="input-group-btn">
                      <button class="btn btn-primary" style="height:30px;" type="button" id="searchBtn" onclick="search_friend()" >Go!</button>
                    </span></div>
                </div>
            </div>
            <div id="login"></div>
            <!-- Friend List and Details-->
            <div class="row" id="heading">
                <div class="col-sm-6">
                    <p style="text-align:center;">
                        <span style="font-family:Arial;font-size:24px;font-style:normal;font-weight:bold;text-decoration:none;text-transform:none;color:FFFFFF;"><u>Friend List</u></span>
                    </p>

                    <div id="left-div" style="overflow: auto; height: 350px; border: 4px solid maroon" align="center"><h2> <span style="font-family:Verdana;font-size:12px;font-weight:bold;color:black;" class="label label-info"> Please import contacts using import button</span> </h2><img src="/images/importContacts.jpeg" alt="Contact import" >
                </div>
            </div>
                <div class="col-sm-6">
                    <p style="text-align:center;">
                        <span style="font-family:Arial;font-size:24px;font-style:normal;font-weight:bold;text-decoration:none;text-transform:none;color:FFFFFF;"><u>Your Friend's Details</u></span>
                    </p>
                    
                    <div align="center" id="right-div" style="overflow: auto; height: 350px;border: 4px solid maroon"><h2> <span style="font-family:Verdana;font-size:12px;font-weight:bold;color:black;" class="label label-info"> Please import contacts using import button</span> </h2><img src="/images/contact-det.jpeg" alt="Contact Details" >
                </div>
                </div>
            </div>


          <!-- Link for exporting friendlist-->
            <div id="export_link" class="col-sm-6">
                <h6 align="left" style="color: red;">**Download contact link will appear here</h6></div>
        </div>
    </div>
        <!--FOOTER-->
        <div id='footer' class='footer'></div>

</body>

</html>